digraph MyGraph {
  rankdir="LR";

  wsa [label="Abstraction"]
  wst [label="Treatment"]
  wsd [label="Distribution"]
  pop [label="Population"]
  ww  [label="Wastewater"]
  unc [label="Uncollected"]
  col [label="Collected"]
  unt [label="Untreated Wastewater"]
  wwt [label="Treatment Plant"]
  ons [label="Onsite Sanitation"]
  dis [label="Discharge"]
  riv [label="Freshwater, estuarine,\nmarine environments"]
  reu [label="Reuse/recovery (agriculture, soils)"]
  slu [label="Dry Sludge"]
  inc [label="Incineration"]
  laf [label="Landfilling"]
  lap [label="Land Application"]
  com [label="Composting"]

  subgraph cluster_ws {
    label="Water Supply"
    wsa -> wst -> wsd [color="blue"]
  }

  wsd -> pop [color="blue"]
  pop -> ww  [color="blue:brown"]

  subgraph cluster_ww{
    label="Wastewater"
    ww  -> {unc col} [color="blue:brown"]
    unc -> {unt ons} [color="blue:brown"]
    col -> {unt wwt} [color="blue:brown"]
  }

  subgraph cluster_dis {
    label="Discharge"
    unt -> riv [color="blue:brown"]
    ons -> dis [color="blue"]
    wwt -> dis [color="blue"]
    dis -> riv [color="blue"]
    dis -> reu [color="blue"]
  }

  subgraph cluster_sm{
    label="Sludge Management"
    {ons wwt} -> slu               [color="brown"]
    slu       -> {inc laf lap com} [color="brown"]
  }

  subgraph cluster_legend {
    rankdi="LR"
    label="Legend"
    legend_a[label="",shape="none"]
    legend_b[label="",shape="none"]
    legend_c[label="",shape="none"]
    legend_d[label="",shape="none"]
    legend_e[label="",shape="none"]
    legend_f[label="",shape="none"]
    legend_g[label="",shape="none"]
    legend_h[label="",shape="none"]
    legend_a -> legend_b [color="blue",       label="water"]
    legend_c -> legend_d [color="brown",      label="sludge"]
    legend_e -> legend_f [color="blue:brown", label="wastewater"]
    legend_g -> legend_h [color="grey",       label="ghg emission"]
  }

  {unt wwt ons riv reu inc laf lap com} -> Atmosphere [color="grey"]
}
